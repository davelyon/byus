$(document).ready( function() {
  window.Link = Backbone.Model.extend({
    initialize: function() {},
    title: function() {return this.get("title")},
    location: function() {return this.attributes.location}
  });

  window.BinLinks = Backbone.Collection.extend({
    model: Link,
    url: function() {
      return "<%= bin_links_path(bin.secret_hash) %>" +
        "/?since=" + this.first().get('created_at');
    },
    getMore: function() {
      var response = $.ajax({
        url: this.url(),
        dataType: 'json',
        async: false
      }).responseText;
      this.add(jQuery.parseJSON(response));
    }
  });

  window.LinkView = Backbone.View.extend({

    tagName: "li",

    template: _.template($('#link-template').html()),

    events: {},

    initialize: function() {
      _.bindAll(this, 'render');
      this.model.bind('change', this.render);
      this.model.view = this;
    },

    render: function() {
      $(this.el).html(this.template(this.model.toJSON()));
      return this;
    },

  });

  window.BinLinksView = Backbone.View.extend({
    el: $('#bin_links'),

    events: {},

    initialize: function() {
      _.bindAll(this, 'addLink', 'addAll');

      Links.bind('add', this.addLink);
      Links.bind('refresh', this.addAll);

      Links.refresh(<%=raw links.to_json %>);
    },

    addLinkPlain: function(link) {
      var view = new LinkView({model: link});
      var renderedView = view.render().el;
      $('.links').append(renderedView);
      return renderedView;
    },

    addLink: function(link) {
      $(this.addLinkPlain(link)).hide().fadeIn(1000);
    },

    addAll: function() {
      console.log('Rendering all');
      Links.each(this.addLinkPlain);
    }
  });

  window.Links = new BinLinks;
  window.App = new BinLinksView;
  setInterval( 'Links.getMore()', 2000);
});
